<!DOCTYPE html>
<html lang="pt-br" class=""> <!-- Classe 'dark' será adicionada dinamicamente -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM - Assistente M</title>
    <!-- Carrega Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Carrega Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar:hover::-webkit-scrollbar-thumb { background: #94a3b8; }
        .dark .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; }
        .dark .custom-scrollbar:hover::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Estilos da Tela de Chat */
        .chat-list { min-width: 280px; max-width: 280px; }
        .chat-bubble-user { background-color: #3b82f6; color: white; border-radius: 1rem 1rem 0.25rem 1rem; }
        .chat-bubble-ai { background-color: #e2e8f0; color: #1e293b; border-radius: 1rem 1rem 1rem 0.25rem; }
        .dark .chat-bubble-ai { background-color: #334155; color: #e2e8f0; }
        
        /* Ajuste para sidebar ativa */
        .nav-link-crm.active {
            background-color: #f3e8ff; /* bg-purple-100 */
            color: #7c3aed; /* text-purple-700 */
        }
        .dark .nav-link-crm.active {
            background-color: rgba(167, 139, 250, 0.1); /* bg-purple-900/50 (aproximado) */
            color: #c4b5fd; /* text-purple-300 */
        }
        
        /* Oculta o Kanban (não é para este CRM) */
        .kanban-board, .kanban-column, .kanban-card { display: none; }
        
        /* Estilos do formulário dinâmico no modal */
        #dynamic-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        #dynamic-form-grid .form-field {
            display: flex;
            flex-direction: column;
        }
        #dynamic-form-grid .form-field label {
            font-size: 0.75rem; /* text-xs */
            font-weight: 500; /* font-medium */
            color: #64748b; /* text-slate-500 */
            margin-bottom: 0.25rem; /* mb-1 */
            text-transform: capitalize;
        }
        #dynamic-form-grid .form-field input,
        #dynamic-form-grid .form-field select,
        #dynamic-form-grid .form-field textarea { /* Adicionado textarea */
            width: 100%;
            padding: 0.5rem 0.75rem; /* px-3 py-2 */
            background-color: #f1f5f9; /* bg-slate-100 */
            border: 1px solid #cbd5e1; /* border-slate-300 */
            border-radius: 0.5rem; /* rounded-lg */
            font-size: 0.875rem; /* text-sm */
        }
        .dark #dynamic-form-grid .form-field input,
        .dark #dynamic-form-grid .form-field select,
        .dark #dynamic-form-grid .form-field textarea {
            background-color: #334155; /* dark:bg-slate-700 */
            border-color: #475569; /* dark:border-slate-600 */
        }
        #dynamic-form-grid .form-field input:disabled,
        #dynamic-form-grid .form-field textarea:disabled {
            background-color: #e2e8f0; /* bg-slate-200 */
            color: #64748b; /* text-slate-500 */
            cursor: not-allowed;
        }
        .dark #dynamic-form-grid .form-field input:disabled,
        .dark #dynamic-form-grid .form-field textarea:disabled {
            background-color: #475569; /* dark:bg-slate-600 */
            color: #94a3b8; /* dark:text-slate-400 */
        }
        #dynamic-form-grid .form-field-full {
            grid-column: 1 / -1; /* Ocupa a linha inteira */
        }
        
    </style>
</head>
<body class="bg-gray-100 dark:bg-slate-900 text-slate-900 dark:text-slate-100">

    <!-- Tela de Carregamento Inicial -->
    <div id="loading-screen" class="fixed inset-0 flex items-center justify-center bg-gray-100 dark:bg-slate-900 z-50">
        <div class="flex flex-col items-center gap-4">
            <i data-lucide="brain-circuit" class="h-12 w-12 text-purple-600 animate-pulse"></i>
            <p class="text-lg font-medium text-slate-700 dark:text-slate-300">Carregando CRM Assistente M...</p>
        </div>
    </div>

    <!-- Tela de Login -->
    <div id="login-screen" class="hidden min-h-screen flex items-center justify-center bg-gray-100 dark:bg-slate-900">
        <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-slate-800 shadow-xl rounded-2xl">
            <div class="flex justify-center">
                <i data-lucide="brain-circuit" class="h-10 w-10 text-purple-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-center">Login - CRM Assistente M</h2>
            <div id="auth-message" class="hidden p-3 rounded-lg text-sm text-center"></div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="login-email" required class="w-full px-4 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="admin@email.com">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium mb-1">Senha</label>
                    <input type="password" id="login-password" required class="w-full px-4 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="••••••••">
                </div>
                <button type="submit" id="login-button" class="w-full bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-200 flex items-center justify-center">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- Aplicação CRM (Oculta por padrão) -->
    <div id="crm-app" class="hidden h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white dark:bg-slate-800 shadow-md z-20 flex-shrink-0">
            <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-4">
                        <i data-lucide="brain-circuit" class="h-8 w-8 text-purple-600"></i>
                        <h1 class="text-xl font-bold text-gray-900 dark:text-white">CRM Assistente M</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <button id="theme-toggle-button" title="Alternar Tema" class="p-2 rounded-full text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700">
                            <i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
                            <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
                        </button>
                        <div class="relative">
                            <button id="user-menu-button" class="flex items-center gap-2 p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
                                <span class="w-8 h-8 rounded-full bg-slate-300 dark:bg-slate-600 flex items-center justify-center">
                                    <i data-lucide="user" class="w-5 h-5"></i>
                                </span>
                                <span id="user-email-display" class="hidden md:block text-sm font-medium"></span>
                                <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                            </button>
                            <!-- Dropdown Menu -->
                            <div id="user-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-lg shadow-xl ring-1 ring-black ring-opacity-5 z-30">
                                <button id="logout-button" class="w-full text-left flex items-center gap-2 px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-b-lg">
                                    <i data-lucide="log-out" class="w-4 h-4"></i>
                                    Sair
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Container Principal (Sidebar + Conteúdo) -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar -->
            <aside class="w-64 bg-white dark:bg-slate-800 shadow-lg flex-shrink-0 overflow-y-auto custom-scrollbar z-10">
                <nav class="p-4 space-y-2">
                    <a href="#" data-view="dashboard" class="nav-link-crm active flex items-center gap-3 px-3 py-2 rounded-lg text-slate-700 dark:text-slate-200 font-medium">
                        <i data-lucide="home" class="w-5 h-5"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" data-view="users" class="nav-link-crm flex items-center gap-3 px-3 py-2 rounded-lg text-slate-700 dark:text-slate-200 font-medium hover:bg-slate-100 dark:hover:bg-slate-700">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        <span>Usuários</span>
                    </a>
                    <a href="#" data-view="chats" class="nav-link-crm flex items-center gap-3 px-3 py-2 rounded-lg text-slate-700 dark:text-slate-200 font-medium hover:bg-slate-100 dark:hover:bg-slate-700">
                        <i data-lucide="message-square" class="w-5 h-5"></i>
                        <span>Conversas</span>
                    </a>
                    <a href="#" data-view="finance" class="nav-link-crm flex items-center gap-3 px-3 py-2 rounded-lg text-slate-700 dark:text-slate-200 font-medium hover:bg-slate-100 dark:hover:bg-slate-700">
                        <i data-lucide="dollar-sign" class="w-5 h-5"></i>
                        <span>Financeiro</span>
                    </a>
                </nav>
            </aside>

            <!-- Área de Conteúdo Principal -->
            <main id="main-content" class="flex-1 p-6 lg:p-8 overflow-y-auto custom-scrollbar">
                <!-- O conteúdo será injetado aqui pelo JavaScript -->
            </main>
        </div>
    </div>

    <!-- Modal Genérico (para Edição de Usuário) -->
    <div id="modal-backdrop" class="hidden fixed inset-0 bg-slate-900/50 dark:bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
         <div id="modal-content" class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-2xl w-full p-6 text-left transform transition-all opacity-0 scale-95">
            <div class="flex items-center justify-between pb-4 border-b dark:border-slate-700">
                <h3 id="modal-title" class="text-lg font-bold">Modal Title</h3>
                <button id="modal-close-button" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
                    <i data-lucide="x" class="w-5 h-5 text-slate-500"></i>
                </button>
            </div>
            <div id="modal-body" class="mt-4 max-h-[70vh] overflow-y-auto custom-scrollbar p-1">
                <!-- Formulário dinâmico será injetado aqui -->
            </div>
            <div id="modal-footer" class="mt-6 pt-4 border-t dark:border-slate-700 flex justify-end gap-3">
                <button id="modal-cancel-button" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 rounded-lg font-semibold transition-colors text-sm">
                    Cancelar
                </button>
                <button id="modal-save-button" class="px-4 py-2 bg-purple-600 text-white hover:bg-purple-700 rounded-lg font-semibold transition-colors text-sm flex items-center gap-2">
                    <i data-lucide="save" class="w-4 h-4"></i>
                    Salvar Alterações
                </button>
            </div>
         </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-[60] space-y-2"></div>


<script type="module">
    // --- CONFIGURAÇÃO ---
    // Insira suas chaves do Supabase aqui
    const SUPABASE_URL = 'https://qedstcloovfgeblduykc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlZHN0Y2xvb3ZmZ2VibGR1eWtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMzk2MzQsImV4cCI6MjA3MDcxNTYzNH0.tq76Qk9pqwb1OutsLX79KgrQhIB8q2ekAcczwhHsxtU';
    
    // Preços dos Planos (Baseado na Landing Page do Assistente M)
    const PLAN_PRICES = {
        'PRO': 47, // Plano Pessoal PRO
        'GRATUITO': 0
        // Adicione outros planos se existirem
    };

    // --- INICIALIZAÇÃO ---
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- Referências de UI ---
    const loadingScreen = document.getElementById('loading-screen');
    const loginScreen = document.getElementById('login-screen');
    const crmApp = document.getElementById('crm-app');
    const loginForm = document.getElementById('login-form');
    const loginEmailInput = document.getElementById('login-email');
    const loginPasswordInput = document.getElementById('login-password');
    const loginButton = document.getElementById('login-button');
    const authMessage = document.getElementById('auth-message');
    const mainContent = document.getElementById('main-content');
    const navLinks = document.querySelectorAll('.nav-link-crm');
    const userMenuButton = document.getElementById('user-menu-button');
    const userMenuDropdown = document.getElementById('user-menu-dropdown');
    const logoutButton = document.getElementById('logout-button');
    const userEmailDisplay = document.getElementById('user-email-display');
    const themeToggleButtons = document.querySelectorAll('#theme-toggle-button, #theme-toggle-button-mobile');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalContent = document.getElementById('modal-content');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalFooter = document.getElementById('modal-footer');
    const modalSaveButton = document.getElementById('modal-save-button');
    const modalCancelButton = document.getElementById('modal-cancel-button');
    const modalCloseButton = document.getElementById('modal-close-button');
    const toastContainer = document.getElementById('toast-container');

    // --- Estado da Aplicação ---
    let currentUser = null;
    let profilesCache = []; // Cache dos perfis de usuário

    // --- FUNÇÕES PRINCIPAIS ---

    /**
     * Inicializa a aplicação, verifica autenticação e define listeners
     */
    async function initApp() {
        // Define o tema
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (savedTheme) setTheme(savedTheme);
        else if (prefersDark) setTheme('dark');
        else setTheme('light');

        if (window.lucide) lucide.createIcons();

        // Verifica estado de autenticação
        supabaseClient.auth.onAuthStateChange((event, session) => {
            currentUser = session?.user || null;
            updateAuthStateUI();
        });

        // Pega sessão inicial (caso a página seja recarregada)
        const { data: { session } } = await supabaseClient.auth.getSession();
        currentUser = session?.user || null;
        updateAuthStateUI();

        // Listeners de UI
        setupEventListeners();
    }

    /**
     * Atualiza a UI com base no estado de login
     */
    function updateAuthStateUI() {
        if (currentUser) {
            loginScreen.classList.add('hidden');
            crmApp.classList.remove('hidden');
            crmApp.classList.add('flex');
            loadingScreen.classList.add('hidden');
            userEmailDisplay.textContent = currentUser.email;
            
            // Carrega a view padrão (Dashboard)
            showView('dashboard');
            // Ativa o link do Dashboard na sidebar
            navLinks.forEach(l => l.classList.remove('active'));
            document.querySelector('.nav-link-crm[data-view="dashboard"]').classList.add('active');
        } else {
            loginScreen.classList.remove('hidden');
            crmApp.classList.add('hidden');
            crmApp.classList.remove('flex');
            loadingScreen.classList.add('hidden');
        }
    }

    /**
     * Fecha o modal
     */
    function closeModal() {
        modalContent.classList.add('opacity-0', 'scale-95');
        setTimeout(() => modalBackdrop.classList.add('hidden'), 200);
    }

    /**
     * Configura todos os event listeners da aplicação
     */
    function setupEventListeners() {
        loginForm.addEventListener('submit', handleLogin);
        logoutButton.addEventListener('click', handleLogout);
        
        userMenuButton.addEventListener('click', () => {
            userMenuDropdown.classList.toggle('hidden');
        });
        
        document.addEventListener('click', (e) => {
            if (e.target !== userMenuButton && !userMenuButton.contains(e.target) && !userMenuDropdown.contains(e.target)) {
                userMenuDropdown.classList.add('hidden');
            }
        });

        themeToggleButtons.forEach(btn => btn.addEventListener('click', toggleTheme));
        
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const viewName = link.dataset.view;
                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                showView(viewName);
            });
        });
        
        // Listeners do Modal
        modalCloseButton.addEventListener('click', closeModal);
        modalCancelButton.addEventListener('click', closeModal);
        modalBackdrop.addEventListener('click', (e) => {
            if (e.target === modalBackdrop) closeModal();
        });
    }

    // --- FUNÇÕES DE NAVEGAÇÃO E RENDERIZAÇÃO ---

    /**
     * Carrega e exibe a view solicitada
     */
    async function showView(viewName) {
        mainContent.innerHTML = `<div class="flex items-center justify-center pt-20"><i data-lucide="loader-2" class="w-8 h-8 text-purple-600 animate-spin"></i></div>`;
        if (window.lucide) lucide.createIcons();
        try {
            switch (viewName) {
                case 'dashboard':
                    await renderDashboard();
                    break;
                case 'users':
                    await renderUsersView();
                    break;
                case 'chats':
                    await renderConversationsView();
                    break;
                case 'finance':
                    await renderFinanceView();
                    break;
                default:
                    mainContent.innerHTML = `<h1 class="text-xl font-bold">Página não encontrada</h1>`;
            }
            if (window.lucide) lucide.createIcons();
        } catch (error) {
            console.error(`Erro ao carregar view ${viewName}:`, error);
            mainContent.innerHTML = `<div class="p-4 bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 rounded-lg">Erro ao carregar dados: ${error.message}</div>`;
        }
    }

    /**
     * Renderiza o Dashboard (focado no Assistente M)
     */
    async function renderDashboard() {
        mainContent.innerHTML = `<h1 class="text-2xl font-bold mb-6">Dashboard (Assistente M)</h1>`;

        const { data: profiles, count, error } = await supabaseClient.from('profiles').select('id, plan', { count: 'exact' });
        if (error) throw error;

        const totalUsers = count || 0;
        let proUsers = 0;
        let mrr = 0;

        profiles.forEach(p => {
            const price = PLAN_PRICES[p.plan];
            if (price && price > 0) {
                mrr += price;
                if (p.plan === 'PRO') {
                    proUsers++;
                }
            }
        });
        
        const freeUsers = totalUsers - proUsers; // Assume que qualquer plano não-PRO é gratuito
        const formattedMRR = mrr.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        
        mainContent.innerHTML += `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"> <!-- Alterado para 4 colunas -->
                <!-- Card MRR (NOVO) -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md flex items-center gap-4">
                    <div class="p-3 rounded-full bg-green-100 dark:bg-green-900/50 text-green-600 dark:text-green-300">
                        <i data-lucide="dollar-sign" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Receita Mensal (MRR)</p>
                        <p class="text-3xl font-bold">${formattedMRR}</p>
                    </div>
                </div>
                <!-- Card Total de Usuários -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md flex items-center gap-4">
                    <div class="p-3 rounded-full bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-300">
                        <i data-lucide="users" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Total de Usuários</p>
                        <p class="text-3xl font-bold">${totalUsers}</p>
                    </div>
                </div>
                <!-- Card Usuários PRO -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md flex items-center gap-4">
                    <div class="p-3 rounded-full bg-purple-100 dark:bg-purple-900/50 text-purple-600 dark:text-purple-300">
                        <i data-lucide="gem" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Assinantes PRO</p>
                        <p class="text-3xl font-bold">${proUsers}</p>
                    </div>
                </div>
                <!-- Card Usuários Gratuitos -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md flex items-center gap-4">
                    <div class="p-3 rounded-full bg-yellow-100 dark:bg-yellow-900/50 text-yellow-600 dark:text-yellow-300">
                        <i data-lucide="gift" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Usuários Gratuitos</p>
                        <p class="text-3xl font-bold">${freeUsers}</p>
                    </div>
                </div>
            </div>
            <p class="mt-4 text-xs text-slate-500 dark:text-slate-400">
                *Receita Mensal (MRR) calculada com base no plano PRO (R$ ${PLAN_PRICES['PRO']}).
            </p>
        `;
    }

    /**
     * Renderiza a visão Financeira (focada no Assistente M)
     */
    async function renderFinanceView() {
        mainContent.innerHTML = `<h1 class="text-2xl font-bold mb-6">Painel Financeiro (Assistente M)</h1>`;
        
        const { data: profiles, error } = await supabaseClient
            .from('profiles')
            .select('plan'); // Pega todos os planos

        if (error) throw error;

        let mrr = 0;
        let proCount = 0;
        // Adicione contadores para outros planos se necessário
        
        profiles.forEach(p => {
            const price = PLAN_PRICES[p.plan];
            if (price && price > 0) {
                mrr += price;
                if (p.plan === 'PRO') {
                    proCount++;
                }
                // Adicione else if para outros planos pagos
            }
        });

        const formattedMRR = mrr.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        mainContent.innerHTML += `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Card MRR -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md flex items-center gap-4">
                    <div class="p-3 rounded-full bg-green-100 dark:bg-green-900/50 text-green-600 dark:text-green-300">
                        <i data-lucide="dollar-sign" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Receita Mensal Recorrente (MRR)</p>
                        <p class="text-3xl font-bold">${formattedMRR}</p>
                    </div>
                </div>
                <!-- Card Assinantes PRO -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md flex items-center gap-4">
                    <div class="p-3 rounded-full bg-purple-100 dark:bg-purple-900/50 text-purple-600 dark:text-purple-300">
                        <i data-lucide="gem" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Assinantes PRO (Pessoal)</p>
                        <p class="text-3xl font-bold">${proCount}</p>
                    </div>
                </div>
            </div>
            <p class="mt-4 text-xs text-slate-500 dark:text-slate-400">
                *Cálculo baseado nos planos pagos (PRO: R$ ${PLAN_PRICES['PRO']}) da tabela 'profiles'.
            </p>
        `;
    }

    /**
     * Renderiza a visão de tabela de Usuários/Perfis
     */
    async function renderUsersView() {
        mainContent.innerHTML = `<h1 class="text-2xl font-bold mb-6">Gerenciamento de Usuários (Assistente M)</h1>`;
        
        const { data, error } = await supabaseClient.from('profiles').select('*').order('created_at', { ascending: false });
        if (error) throw error;
        profilesCache = data || []; // Popula o cache global aqui
        
        const tableContainer = document.createElement('div');
        tableContainer.className = 'bg-white dark:bg-slate-800 shadow-md rounded-lg overflow-hidden';
        tableContainer.innerHTML = `
            <table class="min-w-full divide-y divide-gray-200 dark:divide-slate-700">
                <thead class="bg-gray-50 dark:bg-slate-700">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Nome</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Email</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">WhatsApp JID</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Plano</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Contagem</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody id="users-table-body" class="bg-white dark:bg-slate-800 divide-y divide-gray-200 dark:divide-slate-700"></tbody>
            </table>
        `;
        
        const tableBody = tableContainer.querySelector('#users-table-body');
        if (profilesCache.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-slate-500 dark:text-slate-400">Nenhum usuário encontrado.</td></tr>`;
        } else {
            profilesCache.forEach(profile => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-white">${profile.full_name || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${profile.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400" title="${profile.whatsapp_jid || ''}">${(profile.whatsapp_jid || 'N/A').substring(0, 15)}...</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            profile.plan === 'PRO' ? 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300' :
                            'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300'
                        }">
                            ${profile.plan || 'GRATUITO'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${profile.daily_message_count}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="edit-user-button text-purple-600 hover:text-purple-900 dark:text-purple-400 dark:hover:text-purple-300" data-user-id="${profile.id}">Editar</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }
        
        mainContent.appendChild(tableContainer);
        
        document.querySelectorAll('.edit-user-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const userId = e.target.dataset.userId;
                const profile = profilesCache.find(p => p.id === userId);
                if (profile) openEditUserModal(profile);
            });
        });
    }

    /**
     * Renderiza a visão de Histórico de Conversas
     */
    async function renderConversationsView() {
        mainContent.innerHTML = `
            <h1 class="text-2xl font-bold mb-6">Histórico de Conversas (Assistente M)</h1>
            <div class="flex h-[calc(100vh-10rem)] bg-white dark:bg-slate-800 shadow-md rounded-lg overflow-hidden">
                <!-- Lista de Usuários -->
                <div class="chat-list border-r dark:border-slate-700 overflow-y-auto custom-scrollbar">
                    <div class="p-4 border-b dark:border-slate-700">
                        <input type="text" id="chat-user-search" placeholder="Buscar usuário..." class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div id="chat-user-list" class="divide-y dark:divide-slate-700">
                        <!-- Lista de usuários será injetada aqui -->
                    </div>
                </div>
                <!-- Área do Chat -->
                <div id="chat-display-area" class="flex-1 flex flex-col">
                    <div class="flex-1 p-6 overflow-y-auto custom-scrollbar space-y-4">
                        <p class="text-center text-slate-500 dark:text-slate-400">Selecione um usuário para ver as conversas.</p>
                    </div>
                </div>
            </div>
        `;

        // --- CORREÇÃO APLICADA AQUI ---
        // Removemos a verificação de cache e sempre buscamos os perfis.
        // Usamos uma variável local `profiles` em vez de `profilesCache` para evitar conflitos.
        const { data: profiles, error } = await supabaseClient.from('profiles').select('id, full_name, email').order('full_name');
        if (error) throw error;
        // const profiles = data || []; // Comentário removido

        const userListEl = document.getElementById('chat-user-list');
        userListEl.innerHTML = '';
        
        // --- CORREÇÃO DA VARIÁVEL ---
        if (!profiles || profiles.length === 0) { // <-- Alterado de 'data' para 'profiles'
            userListEl.innerHTML = `<p class="p-4 text-sm text-center text-slate-500 dark:text-slate-400">Nenhum perfil de usuário encontrado.</p>`;
        } else {
            profiles.forEach(profile => { // <-- Alterado de 'data' para 'profiles'
                const userButton = document.createElement('button');
                userButton.className = 'w-full text-left p-4 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors block';
                userButton.dataset.userId = profile.id;
                userButton.innerHTML = `
                    <p class="font-semibold text-sm truncate">${profile.full_name || profile.email}</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400 truncate">${profile.email}</p>
                `;
                userButton.addEventListener('click', () => {
                    userListEl.querySelectorAll('button').forEach(btn => btn.classList.remove('bg-purple-100', 'dark:bg-purple-900/50'));
                    userButton.classList.add('bg-purple-100', 'dark:bg-purple-900/50');
                    loadUserChat(profile.id);
                });
                userListEl.appendChild(userButton);
            });
        }
        // --- FIM DA CORREÇÃO ---

        document.getElementById('chat-user-search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            userListEl.querySelectorAll('button').forEach(button => {
                const name = button.querySelector('p:first-child').textContent.toLowerCase();
                const email = button.querySelector('p:last-child').textContent.toLowerCase();
                button.classList.toggle('hidden', !(name.includes(searchTerm) || email.includes(searchTerm)));
            });
        });
    }

    /**
     * Carrega o histórico de chat de um usuário específico
     * (Esta função já estava correta desde a última vez)
     */
    async function loadUserChat(userId) {
        const chatDisplayArea = document.getElementById('chat-display-area');
        chatDisplayArea.innerHTML = `<div class="flex-1 p-6 overflow-y-auto custom-scrollbar space-y-4"><p class="text-center text-slate-500 dark:text-slate-400">Carregando conversas...</p></div>`;

        // 1. Pega os IDs de TODAS as conversas do usuário
        const { data: convos, error: convoError } = await supabaseClient
            .from('conversations').select('id').eq('user_id', userId);
        
        if (convoError) throw convoError;
        if (convos.length === 0) {
            chatDisplayArea.innerHTML = `<div class="flex-1 p-6 overflow-y-auto custom-scrollbar space-y-4"><p class="text-center text-slate-500 dark:text-slate-400">Este usuário não possui conversas.</p></div>`;
            return;
        }

        // 2. Cria um array com todos os IDs de conversa
        const conversationIds = convos.map(c => c.id);

        // 3. Busca TODAS as mensagens que pertencem a QUALQUER uma dessas conversas
        const { data: messages, error: msgError } = await supabaseClient
            .from('messages')
            .select('*')
            .in('conversation_id', conversationIds) // <-- Usa '.in()'
            .order('created_at', { ascending: true });
        
        if (msgError) throw msgError;

        // 4. Atualiza a UI para refletir todas as mensagens
        chatDisplayArea.innerHTML = `
            <div class="p-4 border-b dark:border-slate-700">
                <h3 class="font-semibold">Histórico de Conversa</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400">Exibindo ${messages.length} mensagens de ${convos.length} conversas.</p>
            </div>
            <div id="chat-messages-content" class="flex-1 p-6 overflow-y-auto custom-scrollbar space-y-4"></div>
        `;
        
        const messagesContent = document.getElementById('chat-messages-content');
        if (messages.length === 0) {
            messagesContent.innerHTML = `<p class="text-center text-slate-500 dark:text-slate-400">Nenhuma mensagem encontrada para este usuário.</p>`;
            return;
        }

        messages.forEach(msg => {
            const bubble = document.createElement('div');
            bubble.className = `flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`;
            bubble.innerHTML = `
                <div class="p-3 max-w-lg ${msg.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}">
                    <p class="text-sm">${msg.content || '(Mídia)'}</p>
                    <p class="text-xs opacity-70 mt-1 text-right">${new Date(msg.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</p>
                </div>
            `;
            messagesContent.appendChild(bubble);
        });
        
        // Garante que o scroll vá para a última mensagem
        messagesContent.scrollTop = messagesContent.scrollHeight;
    }


    // --- FUNÇÕES DE MODAL ---

    /**
     * Abre modal para editar QUALQUER campo do perfil de usuário
     */
    async function openEditUserModal(profile) {
        modalTitle.textContent = `Editar Usuário: ${profile.full_name || profile.email}`;
        
        modalBody.innerHTML = '<div class="text-center text-slate-500">Carregando campos...</div>';
        modalFooter.classList.add('hidden');
        
        modalBackdrop.classList.remove('hidden');
        setTimeout(() => modalContent.classList.remove('opacity-0', 'scale-95'), 10);
        
        const form = document.createElement('form');
        form.id = 'dynamic-edit-form';
        form.className = 'space-y-4';
        
        const grid = document.createElement('div');
        grid.id = 'dynamic-form-grid';
        
        const readOnlyFields = ['id', 'created_at', 'updated_at'];
        const planOptions = ['GRATUITO', 'PRO']; // Planos específicos do Assistente M
        
        for (const [key, value] of Object.entries(profile)) {
            const fieldWrapper = document.createElement('div');
            fieldWrapper.className = 'form-field';
            
            const label = document.createElement('label');
            label.htmlFor = `edit-${key}`;
            label.textContent = key;
            fieldWrapper.appendChild(label);
            
            let input;
            
            if (key === 'plan') {
                input = document.createElement('select');
                input.id = `edit-${key}`;
                input.dataset.key = key;
                planOptions.forEach(planName => {
                    const option = document.createElement('option');
                    option.value = planName;
                    option.textContent = planName;
                    if (value === planName) option.selected = true;
                    input.appendChild(option);
                });
                if (value && !planOptions.includes(value)) {
                     const option = document.createElement('option');
                    option.value = value;
                    option.textContent = `Atual: ${value}`;
                    option.selected = true;
                    input.appendChild(option);
                }
            } else if (key === 'id' || key.includes('_at')) { // Trata todos os campos de data como readonly
                 input = document.createElement('input');
                 input.type = 'text';
                 input.value = value ? new Date(value).toLocaleString('pt-BR') : 'N/A';
                 input.disabled = true;
            } else {
                input = document.createElement('input');
                input.id = `edit-${key}`;
                input.dataset.key = key;

                if (typeof value === 'boolean') {
                    input.type = 'checkbox';
                    input.checked = value;
                    input.className = 'h-6 w-6 rounded';
                } else if (typeof value === 'number') {
                    input.type = 'number';
                    input.value = value;
                } else {
                    input.type = 'text';
                    input.value = value || '';
                }
            }

            // Coloca campos longos em linha inteira
            if (key === 'whatsapp_jid' || key === 'email') {
                 fieldWrapper.classList.add('form-field-full');
            }

            fieldWrapper.appendChild(input);
            grid.appendChild(fieldWrapper);
        }
        
        form.appendChild(grid);
        modalBody.innerHTML = '';
        modalBody.appendChild(form);
        
        modalSaveButton.classList.remove('hidden');
        modalSaveButton.onclick = () => handleUpdateUser(profile.id);
        modalFooter.classList.remove('hidden');
    }
    
    
    /**
     * Salva as alterações de QUALQUER campo do usuário
     */
    async function handleUpdateUser(userId) {
        modalSaveButton.disabled = true;
        modalSaveButton.innerHTML = 'Salvando...';

        const updatedData = {};
        const inputs = modalBody.querySelectorAll('input, select');
        
        inputs.forEach(input => {
            const key = input.dataset.key;
            if (!key || input.disabled) return; 

            let value = input.value;
            
            if (input.type === 'checkbox') {
                value = input.checked;
            } else if (input.type === 'number') {
                value = input.value === '' ? null : parseFloat(input.value);
            } else if (input.type === 'datetime-local') {
                value = input.value === '' ? null : new Date(input.value).toISOString();
            } else if (input.value === '') {
                value = null; 
            }
            
            updatedData[key] = value;
        });

        console.log("Atualizando usuário:", userId, "com dados:", updatedData);

        try {
            const { error } = await supabaseClient
                .from('profiles')
                .update(updatedData)
                .eq('id', userId);
            
            if (error) throw error;
            
            showToast('Usuário atualizado com sucesso!', 'success');
            closeModal();
            await renderUsersView(); // Recarrega a view de usuários
            if (window.lucide) lucide.createIcons();
            
        } catch (error) {
            console.error('Erro ao atualizar usuário:', error);
            showToast(`Erro: ${error.message}`, 'error');
        } finally {
            modalSaveButton.disabled = false;
            modalSaveButton.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i>Salvar Alterações';
            if (window.lucide) lucide.createIcons();
        }
    }


    // --- FUNÇÕES DE AUTENTICAÇÃO ---

    function showLoginMessage(message, type = 'error') {
         authMessage.textContent = message;
         authMessage.className = type === 'error' ?
             'block p-3 rounded-lg text-sm text-center bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300' :
             'block p-3 rounded-lg text-sm text-center bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300';
    }
    
    async function handleLogin(e) {
        e.preventDefault();
        loginButton.disabled = true;
        loginButton.innerHTML = '<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
        
        const { error } = await supabaseClient.auth.signInWithPassword({
            email: loginEmailInput.value,
            password: loginPasswordInput.value
        });
        
        if (error) {
            showLoginMessage(error.message, 'error');
        } else {
            showLoginMessage('Login bem-sucedido!', 'success');
        }
        
        loginButton.disabled = false;
        loginButton.innerHTML = 'Entrar';
    }
    
    async function handleLogout() {
        userMenuDropdown.classList.add('hidden');
        showToast('Saindo...', 'info');
        await supabaseClient.auth.signOut();
    }

    // --- FUNÇÕES UTILITÁRIAS ---

    function setTheme(theme) {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
            localStorage.setItem('theme', 'dark');
        } else {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
        }
        if (window.lucide) lucide.createIcons();
    }
    
    function toggleTheme() {
        const isDark = document.documentElement.classList.contains('dark');
        setTheme(isDark ? 'light' : 'dark');
    }

    function showToast(message, type = 'info', duration = 3000) {
        const toast = document.createElement('div');
        toast.className = `p-3 rounded-lg shadow-lg text-sm font-medium flex items-center gap-2 transform transition-all translate-x-full opacity-0`;
        
        const icons = {
            info: { classes: 'bg-blue-500 text-white', icon: 'info' },
            success: { classes: 'bg-green-500 text-white', icon: 'check-circle' },
            error: { classes: 'bg-red-500 text-white', icon: 'alert-circle' },
            warning: { classes: 'bg-yellow-500 text-white', icon: 'alert-triangle' }
        };
        
        toast.classList.add(...icons[type].classes.split(' '));
        toast.innerHTML = `<i data-lucide="${icons[type].icon}" class="w-5 h-5"></i><span>${message}</span>`;
        
        toastContainer.appendChild(toast);
        if (window.lucide) lucide.createIcons();
        
        setTimeout(() => { toast.classList.remove('translate-x-full', 'opacity-0'); toast.classList.add('translate-x-0', 'opacity-100'); }, 10);
        setTimeout(() => { toast.classList.add('translate-x-full', 'opacity-0'); toast.addEventListener('transitionend', () => toast.remove()); }, duration);
    }
    
    // --- INICIALIZAÇÃO DA APLICAÇÃO ---
    initApp();

</script>

</body>
</html>

